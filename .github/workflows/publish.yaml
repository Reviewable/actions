name: Reusable NPM publish

on:
  workflow_call:
    inputs:
      directory:
        type: string
        default: .

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect package manager
        id: detect-pm
        working-directory: ${{ inputs.directory }}
        run: |
          if [ -f yarn.lock ]; then
            echo "pm=yarn" >> "$GITHUB_OUTPUT"
          else
            echo "pm=npm" >> "$GITHUB_OUTPUT"
          fi

      - name: Resolve Node LTS version
        id: resolve
        run: |
          v=$(curl -s https://nodejs.org/dist/index.json | jq -r '[.[] | select(.lts != false)][0].version')
          echo "version=$v" >> "$GITHUB_OUTPUT"

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ steps.resolve.outputs.version }}
          registry-url: 'https://registry.npmjs.org'
          cache: ${{ steps.detect-pm.outputs.pm }}

      - name: Update npm
        run: npm install -g npm@latest

      - run: ${{ steps.detect-pm.outputs.pm }} install
        working-directory: ${{ inputs.directory }}
      - run: if jq -e '.scripts.build // empty' package.json >/dev/null; then ${{ steps.detect-pm.outputs.pm }} run build; fi
        working-directory: ${{ inputs.directory }}
      - run: if jq -e '.scripts.lint  // empty' package.json >/dev/null; then ${{ steps.detect-pm.outputs.pm }} run lint; fi
        working-directory: ${{ inputs.directory }}
      - run: if jq -e '.scripts.test  // empty' package.json >/dev/null; then ${{ steps.detect-pm.outputs.pm }} run test; fi
        working-directory: ${{ inputs.directory }}

      - name: Verify tarball matches published version (if any)
        id: decide
        working-directory: ${{ inputs.directory }}
        run: |
          set -euo pipefail
      
          decision=$(node << 'EOF'
          const { execSync } = require('node:child_process');
          const fs = require('node:fs');
          const crypto = require('node:crypto');
      
          function sh(cmd) {
            return execSync(cmd, {
              encoding: 'utf8',
              stdio: ['ignore', 'pipe', 'pipe'],
            }).trim();
          }
      
          function pickSha512(integrity) {
            if (!integrity) return null;
            const parts = String(integrity).split(' ');
            const sha512Part = parts.find(p => p.startsWith('sha512-'));
            return sha512Part || parts[0] || null;
          }
      
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          const name = pkg.name;
          const version = pkg.version;
      
          let published;
      
          try {
            const json = sh('npm view ' + name + '@' + version + ' --json');
            published = JSON.parse(json);
          } catch (e) {
            const stderr = String(e.stderr || '');
            if (stderr.includes('E404') || stderr.includes('404 Not Found')) {
              console.error('[decide] ' + name + '@' + version + ' not found; will publish.');
              console.log('publish');
              process.exit(0);
            }
            console.error('[decide] npm view failed unexpectedly:', stderr || e);
            process.exit(1);
          }
      
          const publishedIntegrityRaw = published.dist && published.dist.integrity;
          const publishedIntegrity = pickSha512(publishedIntegrityRaw);
          if (!publishedIntegrity) {
            console.error('[decide] existing version lacks usable dist.integrity; refusing.');
            process.exit(1);
          }
      
          console.error('[decide] building tarball…');
          sh('npm pack --silent');
      
          const file = fs.readdirSync('.').find(f => f.endsWith('.tgz'));
          if (!file) {
            console.error('[decide] npm pack produced no .tgz file.');
            process.exit(1);
          }
      
          console.error('[decide] computing local integrity…');
          const data = fs.readFileSync(file);
          const hash = crypto.createHash('sha512').update(data).digest('base64');
          const localIntegrity = 'sha512-' + hash;
      
          if (localIntegrity === publishedIntegrity) {
            console.error('[decide] identical tarball already published; skipping.');
            console.log('skip');
            process.exit(0);
          }
      
          console.error('[decide] version exists but tarballs differ; refusing.');
          process.exit(1);
          EOF
          )

          echo "decision=${decision}" >> "$GITHUB_OUTPUT"
          
      - run: npm publish
        if: steps.decide.outputs.decision == 'publish'
        working-directory: ${{ inputs.directory }}
