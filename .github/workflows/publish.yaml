name: Reusable NPM publish

on:
  workflow_call:
    inputs:
      directory:
        type: string
        default: .

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Detect package manager
        id: detect-pm
        working-directory: ${{ inputs.directory }}
        run: |
          if [ -f yarn.lock ]; then
            echo "pm=yarn" >> "$GITHUB_OUTPUT"
          else
            echo "pm=npm" >> "$GITHUB_OUTPUT"
          fi

      - name: Resolve Node LTS version
        id: resolve
        run: |
          v=$(curl -s https://nodejs.org/dist/index.json | jq -r '[.[] | select(.lts != false)][0].version')
          echo "version=$v" >> "$GITHUB_OUTPUT"

      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ steps.resolve.outputs.version }}
          registry-url: 'https://registry.npmjs.org'
          cache: ${{ steps.detect-pm.outputs.pm }}

      - name: Update npm
        run: npm install -g npm@latest

      - run: ${{ steps.detect-pm.outputs.pm }} install
        working-directory: ${{ inputs.directory }}
      - run: if jq -e '.scripts.build // empty' package.json >/dev/null; then ${{ steps.detect-pm.outputs.pm }} run build; fi
        working-directory: ${{ inputs.directory }}
      - run: if jq -e '.scripts.lint  // empty' package.json >/dev/null; then ${{ steps.detect-pm.outputs.pm }} run lint; fi
        working-directory: ${{ inputs.directory }}
      - run: if jq -e '.scripts.test  // empty' package.json >/dev/null; then ${{ steps.detect-pm.outputs.pm }} run test; fi
        working-directory: ${{ inputs.directory }}
      - run: npm publish
        working-directory: ${{ inputs.directory }}
